<!DOCTYPE html>

<html lang="en">
	<head>
		<title>TicTacToe | ???</title>

		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="theme-color" content="#4ecdc4" />

		<link rel="icon" href="../images/icon.png" />
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

		<meta property="og:url" content="https://pinniped.page/projects/tictactoe" />
		<meta property="og:type" content="website" />
		<meta property="og:title" content="TicTacToe" />
		<meta property="og:description" content="The classic game of Xs and Os, but it's an online 1v1." />
		<meta property="og:image" content="https://pinniped.page/images/icon.png" />

		<style>
			@import url("https://fonts.googleapis.com/css2?family=Oswald");

			* {
				outline: none;
			}

			body {
				margin: 0;
				border: 0;
				padding: 0;

				transition: height 0.5s;

				font-family: "Oswald";
				font-size: 24px;
				background-color: #edf6f9;
				color: #006d77;

				display: flex;
				align-items: center;
				justify-content: center;
				overflow: hidden;
			}

			::selection {
				background-color: #006d77;
				color: #edf6f9;
			}

			.brown::selection {
				background-color: #e29578;
				color: #edf6f9;
			}

			h1,
			p {
				margin: 0;
				border: 0;
				padding: 0;
			}

			h1 {
				font-size: 100px;
			}

			p {
				position: fixed;
			}

			img {
				user-select: none;
			}

			i.fa-xmark {
				font-size: 150px;
			}

			i.fa-o {
				font-size: 120px;
			}

			.button {
				text-decoration: underline;
				text-decoration-color: transparent;
				text-underline-offset: 5px;
				transition: text-decoration-color 0.5s;
				user-select: none;
			}

			.button:hover {
				cursor: pointer;
				text-decoration-color: inherit;
			}

			.button:focus {
				text-decoration-color: inherit;
			}

			.button:first-child {
				top: 10px;
				left: 20px;
			}

			.text-below {
				bottom: 50px;
				font-size: 48px;
			}

			.menu {
				position: fixed;
				width: 100%;
				height: 100%;
				background-color: #edf6f9;

				display: flex;
				align-items: center;
				justify-content: center;
			}

			.main-menu p,
			input {
				position: sticky;
				width: 200px;
				height: 40px;
				border: 3px solid #83c5be;
				margin: auto;
				font-size: 18px;

				display: flex;
				align-items: center;
				justify-content: center;
				transition: border-color 0.5s;
			}

			.main-menu p:hover {
				border-color: #006d77;
				cursor: pointer;
			}

			.main-menu p:focus {
				border-color: #006d77;
			}

			.brown {
				color: #e29578;
			}

			input {
				margin-top: 10px;
				padding: 0;
				font-family: "Oswald";
				background-color: #edf6f9;
				text-align: center;
				color: #006d77;
			}

			input:focus {
				border-color: #006d77;
			}

			::placeholder {
				text-align: center;
				color: #83c5be;
			}

			input:hover {
				outline: none;
			}

			#board {
				width: 470px;
				display: flex;
				flex-wrap: wrap;
			}

			#board div {
				width: 150px;
				height: 150px;

				display: flex;
				align-items: center;
				justify-content: center;
			}

			#square1 {
				border-right: 5px solid #83c5be;
				border-bottom: 5px solid #83c5be;
			}

			#square2 {
				border-right: 5px solid #83c5be;
				border-bottom: 5px solid #83c5be;
				border-left: 5px solid #83c5be;
			}

			#square3 {
				border-bottom: 5px solid #83c5be;
				border-left: 5px solid #83c5be;
			}

			#square4 {
				border-top: 5px solid #83c5be;
				border-right: 5px solid #83c5be;
				border-bottom: 5px solid #83c5be;
			}

			#square5 {
				border: 5px solid #83c5be;
			}

			#square6 {
				border-top: 5px solid #83c5be;
				border-bottom: 5px solid #83c5be;
				border-left: 5px solid #83c5be;
			}

			#square7 {
				border-top: 5px solid #83c5be;
				border-right: 5px solid #83c5be;
			}

			#square8 {
				border-top: 5px solid #83c5be;
				border-right: 5px solid #83c5be;
				border-left: 5px solid #83c5be;
			}

			#square9 {
				border-top: 5px solid #83c5be;
				border-left: 5px solid #83c5be;
			}

			#d1,
			#d2,
			#d3 {
				opacity: 0%;
			}

			#d1 {
				animation: d1 2.5s infinite 0.5s;
			}

			#d2 {
				animation: d2 2.5s infinite 0.5s;
			}

			#d3 {
				animation: d3 2.5s infinite 0.5s;
			}

			#code {
				font-size: 48px;
				top: 50px;
				right: 100px;
			}

			@keyframes d1 {
				0% {
					opacity: 0%;
				}
				20% {
					opacity: 100%;
				}
				40% {
					opacity: 100%;
				}
				60% {
					opacity: 100%;
				}
				80% {
					opacity: 100%;
				}
				100% {
					opacity: 0%;
				}
			}

			@keyframes d2 {
				0% {
					opacity: 0%;
				}
				20% {
					opacity: 0%;
				}
				40% {
					opacity: 100%;
				}
				60% {
					opacity: 100%;
				}
				80% {
					opacity: 100%;
				}
				100% {
					opacity: 0%;
				}
			}

			@keyframes d3 {
				0% {
					opacity: 0%;
				}
				20% {
					opacity: 0%;
				}
				40% {
					opacity: 0%;
				}
				60% {
					opacity: 100%;
				}
				80% {
					opacity: 100%;
				}
				100% {
					opacity: 0%;
				}
			}

			@media all and (max-width: 900px) {
				#code {
					top: 25px;
					right: 50px;
				}
			}

			@media all and (max-width: 700px) {
				#board {
					width: 320px;
				}

				#board div {
					width: 100px;
					height: 100px;
				}
			}

			@media all and (max-width: 400px) {
				.text-below {
					font-size: 36px;
				}
			}

			@media all and (max-width: 400px) {
				h1 {
					font-size: 90px;
				}
			}

			@media all and (max-width: 350px) {
				#board {
					width: 245px;
				}

				#board div {
					width: 75px;
					height: 75px;
				}

				h1 {
					font-size: 80px;
				}

				.text-below {
					font-size: 32px;
				}
			}

			@media all and (max-width: 300px) {
				.text-below {
					font-size: 24px;
				}
			}

			@media all and (max-width: 320px) {
				h1 {
					font-size: 70px;
				}
			}

			@media all and (max-width: 280px) {
				#board {
					width: 170px;
				}

				#board div {
					width: 50px;
					height: 50px;
				}

				h1 {
					font-size: 60px;
				}
			}

			@media all and (max-height: 730px) {
				#board {
					width: 320px;
				}

				#board div {
					width: 100px;
					height: 100px;
				}

				.text-below {
					bottom: 40px;
				}
			}

			@media all and (max-height: 570px) {
				#board {
					width: 245px;
				}

				#board div {
					width: 75px;
					height: 75px;
				}

				.text-below {
					bottom: 30px;
				}
			}

			@media all and (max-height: 490px) {
				#board {
					width: 170px;
				}

				#board div {
					width: 50px;
					height: 50px;
				}

				.text-below {
					bottom: 20px;
					font-size: 36px;
				}
			}

			@media all and (max-height: 400px) {
				.text-below {
					bottom: 10px;
				}
			}

			@media all and (max-height: 360px) {
				.text-below {
					bottom: 5px;
					font-size: 32px;
				}
			}
		</style>

		<style id="toggleStyle1">
			#board div:not(div:has(img)):hover {
				cursor: pointer;
				background-color: #83c5be50;
			}

			#board div:not(div:has(img)):focus {
				background-color: #83c5be50;
			}
		</style>
	</head>

	<body draggable="false">
		<p id="backButton" style="display: none" class="button" tabindex="1">
			<span class="material-icons" style="translate: 0 2px; margin-right: 5px">navigate_before</span>Back
		</p>

		<div id="board" draggable="false" style="display: none">
			<div id="square1" tabindex="2"></div>
			<div id="square2" tabindex="3"></div>
			<div id="square3" tabindex="4"></div>

			<div id="square4" tabindex="5"></div>
			<div id="square5" tabindex="6"></div>
			<div id="square6" tabindex="7"></div>

			<div id="square7" tabindex="8"></div>
			<div id="square8" tabindex="9"></div>
			<div id="square9" tabindex="10"></div>
		</div>

		<p class="text-below" style="display: none">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></p>

		<p id="code" class="brown" style="display: none"></p>

		<div class="menu">
			<p id="exitButton" class="button" style="top: 10px; left: 20px" tabindex="0">
				<span class="material-icons" style="translate: 0 2px; margin-right: 5px">navigate_before</span>Exit
			</p>

			<div class="main-menu">
				<h1>TicTacToe</h1>
				<p id="newGameButton" tabindex="0">NEW GAME</p>
				<form name="joinGameForm">
					<input
						name="joinGameInput"
						type="text"
						placeholder="ENTER GAME CODE"
						maxlength="7"
						autocapitalize="off"
						spellcheck="false"
						autocomplete="off"
						pattern="^[a-zA-Z0-9]{7}$"
					/>
				</form>
			</div>
		</div>
	</body>

	<script type="module">
		// URL stuff
		const query = window.location.search;
		const item = new URLSearchParams(query);
		var origin = item.get("o");
		var gameCode = item.get("c");
		if (origin != 1) {
			origin = 0;
			if (gameCode != null && gameCode != "") window.history.pushState({}, "", `?o=${origin}&c=${gameCode}`);
			else window.history.pushState({}, "", `?o=${origin}`);
		}

		// variables
		var code;
		var keys = {};
		var turn = true;
		var player = true;
		var hasWon = false;
		var gameStarted = false;
		var squares = ["1", "2", "3", "4", "5", "6", "7", "8", "9"];
		var textBelow = document.querySelector("p.text-below");
		var ogToggleStyle1 = document.querySelector("#toggleStyle1").innerHTML;

		// perfect position
		function updateBodySize() {
			document.querySelector("body").style = `height: ${window.innerHeight}px`;
		}
		updateBodySize();

		// update perfect position on resize
		addEventListener("resize", (e) => {
			setTimeout(() => {
				updateBodySize();
			}, 500);
		});

		// exit game (go to menu)
		function exitGame() {
			window.location.href = "tictactoe.html?o=" + origin;
		}

		// exit 'app' (return to origin)
		function leave() {
			if (origin == 1) window.location.href = "../projects+.html";
			else window.location.href = "../projects.html";
		}

		// place X or O
		function placeXO(square, XO) {
			document.querySelector(`#square${square}`).innerHTML = `<img src="../images/ttt-${XO}.svg" draggable="false">`;
			squares[square - 1] = XO;
		}

		// swap turn
		function swapTurn() {
			turn = !turn;
			console.log("turn=" + turn, "player=" + player);
			if (document.querySelector("#toggleStyle1").innerHTML == "") document.querySelector("#toggleStyle1").innerHTML = ogToggleStyle1;
			else document.querySelector("#toggleStyle1").innerHTML = "";
		}

		// listen for clicks on square
		function handleClick(square) {
			console.log("turn=" + turn, "player=" + player);
			if (turn == player && document.querySelector(`#square${square}`).innerHTML == "" && !hasWon) {
				if (turn) {
					placeXO(square, "x");
					textBelow.innerHTML = "Waiting for opponent<d id='d1'>.</d><d id='d2'>.</d><d id='d3'>.</d>";
				} else {
					placeXO(square, "o");
					textBelow.innerHTML = "It's your turn!";
				}

				let move = "";
				if (player) move = move + "x";
				else move = move + "o";
				move = move + square;
				makeMove(move);

				console.log("made it here");
				swapTurn();
				checkForWin();
			}
		}

		// win?
		function checkForWin() {
			if (squares[0] == squares[1] && squares[1] == squares[2]) handleWin(!turn, 0, 1, 2);
			else if (squares[3] == squares[4] && squares[4] == squares[5]) handleWin(!turn, 3, 4, 5);
			else if (squares[6] == squares[7] && squares[7] == squares[8]) handleWin(!turn, 6, 7, 8);
			else if (squares[0] == squares[3] && squares[3] == squares[6]) handleWin(!turn, 0, 3, 6);
			else if (squares[1] == squares[4] && squares[4] == squares[7]) handleWin(!turn, 1, 4, 7);
			else if (squares[2] == squares[5] && squares[5] == squares[8]) handleWin(!turn, 2, 5, 8);
			else if (squares[0] == squares[4] && squares[4] == squares[8]) handleWin(!turn, 0, 4, 8);
			else if (squares[2] == squares[4] && squares[4] == squares[6]) handleWin(!turn, 2, 4, 6);
			else if (
				(squares[0] == "x" || squares[0] == "o") &&
				(squares[1] == "x" || squares[1] == "o") &&
				(squares[2] == "x" || squares[2] == "o") &&
				(squares[3] == "x" || squares[3] == "o") &&
				(squares[4] == "x" || squares[4] == "o") &&
				(squares[5] == "x" || squares[5] == "o") &&
				(squares[6] == "x" || squares[6] == "o") &&
				(squares[7] == "x" || squares[7] == "o") &&
				(squares[8] == "x" || squares[8] == "o")
			) {
				handleWin();
			}
		}

		// after win
		function handleWin(winner, win1, win2, win3) {
			if (winner == player) textBelow.innerHTML = "You win!";
			else if (winner != null) textBelow.innerHTML = "You lose.";
			else textBelow.innerHTML = "You tied.";
			hasWon = true;
			document.querySelector("#toggleStyle1").innerHTML = "";

			for (let i = 0; i < 9; i++) {
				if (i != win1 && i != win2 && i != win3) {
					let squareElement = document.querySelector(`#square${i + 1}`);
					if (squareElement.innerHTML != "") {
						squareElement.children[0].style = "opacity: 50%";
					}
				}
			}
		}

		// fullscreen (we like that)
		function toggleFullscreen() {
			if (document.fullscreenElement) document.exitFullscreen();
			else document.documentElement.requestFullscreen();
		}

		// keyboard shortcuts and related functions
		document.addEventListener("keydown", (e) => {
			keys[e.key] = true;

			if (e.keyCode > 48 && e.keyCode < 58 && gameStarted) handleClick(e.keyCode - 48);
			if (keys["Shift"] && e.key === "Enter") toggleFullscreen();

			if (e.key === "Enter") {
				if (document.activeElement == document.querySelector(".menu .button")) leave();
				if (document.activeElement == document.querySelector(".main-menu p")) createGame();
				if (document.activeElement == document.querySelector(".button")) exitGame();

				for (let i = 1; i <= 9; i++) if (document.activeElement == document.querySelector(`#square${i}`)) handleClick(i);
			}
		});
		document.addEventListener("keyup", (e) => {
			delete keys[e.key];
		});

		// prevent default form submitting
		document.querySelector("form").addEventListener("submit", (e) => {
			e.preventDefault();
			code = document.joinGameForm.joinGameInput.value;
			joinGame();
		});

		// generate game code
		const chars = [
			"a",
			"b",
			"c",
			"d",
			"e",
			"f",
			"g",
			"h",
			"i",
			"j",
			"k",
			"l",
			"m",
			"n",
			"o",
			"p",
			"q",
			"r",
			"s",
			"t",
			"u",
			"v",
			"w",
			"x",
			"y",
			"z",
			"A",
			"B",
			"C",
			"D",
			"E",
			"F",
			"G",
			"H",
			"I",
			"J",
			"K",
			"L",
			"M",
			"N",
			"O",
			"P",
			"Q",
			"R",
			"S",
			"T",
			"U",
			"V",
			"W",
			"X",
			"Y",
			"Z",
			"0",
			"1",
			"2",
			"3",
			"4",
			"5",
			"6",
			"7",
			"8",
			"9",
		];
		function genCode(length) {
			let codeString = "";
			for (let i = 0; i < length; i++) codeString = codeString + chars[Math.floor(Math.random() * chars.length)];
			code = codeString;
		}

		// show/hide board
		function toggleBoardDisplay(showHide) {
			if (showHide) {
				document.querySelector(".menu").style = "display: none";

				document.querySelector(".button").style = "display: block";
				document.querySelector("#board").style = "display: flex";
				document.querySelector(".text-below").style = "display: block";
				document.querySelector("#code").style = "display: block";
			} else {
				document.querySelector(".menu").style = "display: flex";

				document.querySelector(".button").style = "display: none";
				document.querySelector("#board").style = "display: none";
				document.querySelector(".text-below").style = "display: none";
				document.querySelector("#code").style = "display: none";
			}
		}

		// show the code and put it in the URL and title
		function setCode(code) {
			window.history.pushState({}, "", `?o=${origin}&c=${code}`);
			document.querySelector("title").innerHTML = "TicTacToe | " + code;
			document.querySelector("#code").innerHTML = code;
		}

		// create a new game
		function createGame() {
			genCode(7);
			initGame(code);
			setCode(code);
			textBelow.innerHTML = "It's your turn!";
			toggleBoardDisplay(true);

			console.log("turn=" + turn, "player=" + player);
		}

		// join an existing game
		function joinGame() {
			setCode(code);
			findGame();
			toggleBoardDisplay(true);

			console.log("turn=" + turn, "player=" + player);
		}

		// click listeners
		document.querySelector("#backButton").addEventListener("click", (e) => {
			exitGame();
		});
		document.querySelector("#exitButton").addEventListener("click", (e) => {
			leave();
		});
		document.querySelector("#newGameButton").addEventListener("click", (e) => {
			createGame();
		});
		for (let i = 1; i <= 9; i++) {
			document.querySelector(`#square${i}`).addEventListener("click", (e) => {
				handleClick(i);
			});
		}

		// --- FIREBASE ---

		// fireBASED
		import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
		import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

		// firebase = wow!
		const firebaseConfig = {
			apiKey: "AIzaSyAigBAgn7Uhybip_m3P508DIpybb2qdI5g",
			authDomain: "the-pinniped-page.firebaseapp.com",
			databaseURL: "https://the-pinniped-page.firebaseio.com",
			projectId: "the-pinniped-page",
			storageBucket: "the-pinniped-page.appspot.com",
			messagingSenderId: "636989973689",
			appId: "1:636989973689:web:6d938d9588606d803a6768",
		};
		const app = initializeApp(firebaseConfig);

		// create game - on Firebase Realtime Database
		function initGame(code) {
			const db = getDatabase();
			let date = new Date();

			set(ref(db, "tictactoe/" + code), {
				data: {
					date: date.toString(),
					timestamp: date.getTime(),
				},
			});
			getOpponentMoves();
		}

		// make move on server
		function makeMove(move) {
			console.log("move made");
			const db = getDatabase();

			set(ref(db, "tictactoe/" + code + "/move"), move);
		}

		// find game? !!! this kinda goes against the 'modular functions' I'm going for - or something like that
		function findGame() {
			const dbRef = ref(getDatabase());
			get(child(dbRef, "tictactoe/" + code)).then((snapshot) => {
				if (!snapshot.exists()) {
					textBelow.innerHTML = "ERROR: game not found";
					hasWon = true; // well, uh, technically, uh, nah
				} else {
					textBelow.innerHTML = "Waiting for opponent<d id='d1'>.</d><d id='d2'>.</d><d id='d3'>.</d>";
					player = false;
					console.log("turn=" + turn, "player=" + player);
				}
				document.querySelector("#toggleStyle1").innerHTML = "";
			});
			getOpponentMoves();
		}

		// URL stuff 2.0
		if (gameCode != null && gameCode != "") {
			if (/^[a-zA-Z0-9]{7}$/.test(gameCode)) {
				code = gameCode;
				joinGame();
			}
		}

		// get opponent moves
		function getOpponentMoves() {
			const db = getDatabase();
			const moveRef = ref(db, "tictactoe/" + code + "/move");
			onValue(moveRef, (snapshot) => {
				const data = snapshot.val();

				if (data != null) {
					let newData = data.toString();
					console.log(newData);
					placeXO(newData.substring(1, 2), newData.substring(0, 1));
					if (newData.substring(0, 1) == "x" && !player) swapTurn();
					if (newData.substring(0, 1) == "o" && player) swapTurn();
					checkForWin();
				}
			});
		}
	</script>
</html>
