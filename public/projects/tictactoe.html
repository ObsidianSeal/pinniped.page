<!DOCTYPE html>

<html lang="en">
	<head>
		<title>TicTacToe</title>

		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="theme-color" content="#4ecdc4" />

		<link rel="icon" href="../images/icon.png" />
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

		<meta property="og:url" content="https://pinniped.page/projects/tictactoe" />
		<meta property="og:type" content="website" />
		<meta property="og:title" content="TicTacToe" />
		<meta property="og:description" content="The classic game of Xs and Os, but it's an online 1v1." />
		<meta property="og:image" content="https://pinniped.page/images/icon.png" />

		<style>
			@import url("https://fonts.googleapis.com/css2?family=Oswald");

			* {
				outline: none;
			}

			body {
				margin: 0;
				border: 0;
				padding: 0;

				transition: height 0.5s;

				font-family: "Oswald";
				font-size: 24px;
				background-color: #edf6f9;
				color: #006d77;

				display: flex;
				align-items: center;
				justify-content: center;
			}

			::-webkit-scrollbar {
				width: 20px;
			}

			::-webkit-scrollbar-thumb {
				background-color: #83c5be;
			}

			::-webkit-scrollbar-thumb:hover {
				background-color: #006d77;
			}

			::-webkit-scrollbar-track {
				background-color: #edf6f9;
			}

			::-webkit-scrollbar-corner {
				background-color: #edf6f9;
			}

			::selection {
				background-color: #006d77;
				color: #edf6f9;
			}

			.data-area span::selection {
				background-color: #83c5be;
				color: #edf6f9;
			}

			h2::selection,
			.brown::selection,
			.data-area d::selection {
				background-color: #e29578;
				color: #edf6f9;
			}

			h1,
			p {
				margin: 0;
				border: 0;
				padding: 0;
			}

			h1 {
				font-size: 100px;
			}

			h2 {
				margin: 0;
				color: #e29578;

				font-size: 50px;
				font-weight: normal;
			}

			p {
				position: fixed;
			}

			.data-area p {
				position: initial;
				margin-top: 20px;
			}

			img {
				user-select: none;
			}

			i.fa-xmark {
				font-size: 150px;
			}

			i.fa-o {
				font-size: 120px;
			}

			.button {
				text-decoration: underline;
				text-decoration-color: transparent;
				text-underline-offset: 5px;
				transition: text-decoration-color 0.5s;
				user-select: none;
			}

			.button:hover {
				cursor: pointer;
				text-decoration-color: inherit;
			}

			.button:focus {
				text-decoration-color: inherit;
			}

			.button:first-child {
				top: 10px;
				left: 20px;
			}

			.text-below {
				bottom: 50px;
				font-size: 48px;
			}

			.menu {
				position: fixed;
				width: 100%;
				height: 100%;
				background-color: #edf6f9;

				display: flex;
				align-items: center;
				justify-content: center;
			}

			.main-menu p,
			input {
				position: sticky;
				width: 200px;
				height: 40px;
				border: 3px solid #83c5be;
				margin: auto;
				font-size: 18px;

				display: flex;
				align-items: center;
				justify-content: center;
				transition: border-color 0.5s;
			}

			.main-menu p:hover {
				border-color: #006d77;
				cursor: pointer;
			}

			.main-menu p:focus {
				border-color: #006d77;
			}

			.light-blue {
				color: #83c5be;
			}

			.brown {
				color: #e29578;
			}

			.big-icon .material-symbols-outlined {
				font-size: 48px;
				font-variation-settings: "FILL" 0, "wght" 600, "GRAD" 0, "opsz" 48;
			}

			.small-icon {
				font-variation-settings: "FILL" 1, "wght" 600, "GRAD" 0, "opsz" 24;
				translate: 0 3px;
				user-select: none;
			}

			.button-tray {
				left: 20px;
				bottom: 10px;
				user-select: none;
			}

			.button-tray span {
				margin-right: 5px;
				transition: color 0.5s;
			}

			.button-tray span:hover {
				color: #006d77;
				cursor: pointer;
			}

			.button-tray span:focus {
				color: #006d77;
			}

			.data-page {
				margin-right: auto;
				margin-bottom: auto;
			}

			.data-area {
				margin: 100px 50px 0 50px;
				padding-bottom: 100px;
			}

			.data-area span {
				color: #83c5be;
			}

			.tooltip-zone {
				width: fit-content;
			}

			input {
				margin-top: 10px;
				padding: 0;
				font-family: "Oswald";
				background-color: #edf6f9;
				text-align: center;
				color: #006d77;
			}

			::placeholder {
				text-align: center;
				color: #83c5be;
			}

			input:hover {
				outline: none;
			}

			input:focus {
				border-color: #006d77;
			}

			#board {
				width: 470px;
				display: flex;
				flex-wrap: wrap;
			}

			#board div {
				width: 150px;
				height: 150px;

				display: flex;
				align-items: center;
				justify-content: center;
			}

			#square1 {
				border-right: 5px solid #83c5be;
				border-bottom: 5px solid #83c5be;
			}

			#square2 {
				border-right: 5px solid #83c5be;
				border-bottom: 5px solid #83c5be;
				border-left: 5px solid #83c5be;
			}

			#square3 {
				border-bottom: 5px solid #83c5be;
				border-left: 5px solid #83c5be;
			}

			#square4 {
				border-top: 5px solid #83c5be;
				border-right: 5px solid #83c5be;
				border-bottom: 5px solid #83c5be;
			}

			#square5 {
				border: 5px solid #83c5be;
			}

			#square6 {
				border-top: 5px solid #83c5be;
				border-bottom: 5px solid #83c5be;
				border-left: 5px solid #83c5be;
			}

			#square7 {
				border-top: 5px solid #83c5be;
				border-right: 5px solid #83c5be;
			}

			#square8 {
				border-top: 5px solid #83c5be;
				border-right: 5px solid #83c5be;
				border-left: 5px solid #83c5be;
			}

			#square9 {
				border-top: 5px solid #83c5be;
				border-left: 5px solid #83c5be;
			}

			#d1,
			#d2,
			#d3 {
				opacity: 0%;
			}

			#d1 {
				animation: d1 2.5s infinite 0.5s;
			}

			#d2 {
				animation: d2 2.5s infinite 0.5s;
			}

			#d3 {
				animation: d3 2.5s infinite 0.5s;
			}

			#code {
				font-size: 48px;
				top: 50px;
				right: 100px;
				user-select: none;
				text-underline-offset: 15px;
			}

			#backButton2 {
				top: 0;
				left: 0px;

				width: 100%;
				padding: 10px 0 10px 20px;
				background-color: #edf6f9;

				box-shadow: 0 0 10px 5px #edf6f9;

				z-index: 2;
			}

			#tooltip {
				position: fixed;

				padding: 0 10px 5px 10px;

				background-color: #006d77;
				color: #edf6f9;

				user-select: none;
			}

			#data-refresh {
				font-variation-settings: "FILL" 0, "wght" 600, "GRAD" 0, "opsz" 24;
				font-size: 48px;
				user-select: none;
				transition: color 0.5s;
			}

			#data-refresh:hover {
				cursor: pointer;
				color: #006d77;
			}

			@keyframes d1 {
				0% {
					opacity: 0%;
				}
				20% {
					opacity: 100%;
				}
				40% {
					opacity: 100%;
				}
				60% {
					opacity: 100%;
				}
				80% {
					opacity: 100%;
				}
				100% {
					opacity: 0%;
				}
			}

			@keyframes d2 {
				0% {
					opacity: 0%;
				}
				20% {
					opacity: 0%;
				}
				40% {
					opacity: 100%;
				}
				60% {
					opacity: 100%;
				}
				80% {
					opacity: 100%;
				}
				100% {
					opacity: 0%;
				}
			}

			@keyframes d3 {
				0% {
					opacity: 0%;
				}
				20% {
					opacity: 0%;
				}
				40% {
					opacity: 0%;
				}
				60% {
					opacity: 100%;
				}
				80% {
					opacity: 100%;
				}
				100% {
					opacity: 0%;
				}
			}

			@media all and (max-width: 900px) {
				#code {
					top: 25px;
					right: 50px;
				}
			}

			@media all and (max-width: 700px) {
				#board {
					width: 320px;
				}

				#board div {
					width: 100px;
					height: 100px;
				}
			}

			@media all and (max-width: 550px) {
				.button-tray {
					left: inherit;
				}

				#downloadButton {
					display: none;
				}
			}

			@media all and (max-width: 460px) {
				.data-area h1 {
					font-size: 60px;
				}
			}

			@media all and (max-width: 400px) {
				h1 {
					font-size: 90px;
				}

				.text-below {
					font-size: 36px;
				}
			}

			@media all and (max-width: 350px) {
				#board {
					width: 245px;
				}

				#board div {
					width: 75px;
					height: 75px;
				}

				h1 {
					font-size: 80px;
				}

				.text-below {
					font-size: 32px;
				}
			}

			@media all and (max-width: 300px) {
				.text-below {
					font-size: 24px;
				}
			}

			@media all and (max-width: 320px) {
				h1 {
					font-size: 70px;
				}
			}

			@media all and (max-width: 280px) {
				#board {
					width: 170px;
				}

				#board div {
					width: 50px;
					height: 50px;
				}

				h1 {
					font-size: 60px;
				}
			}

			@media all and (max-height: 730px) {
				#board {
					width: 320px;
				}

				#board div {
					width: 100px;
					height: 100px;
				}

				.text-below {
					bottom: 40px;
				}
			}

			@media all and (max-height: 570px) {
				#board {
					width: 245px;
				}

				#board div {
					width: 75px;
					height: 75px;
				}

				.text-below {
					bottom: 30px;
				}
			}

			@media all and (max-height: 490px) {
				#board {
					width: 170px;
				}

				#board div {
					width: 50px;
					height: 50px;
				}

				.text-below {
					bottom: 20px;
					font-size: 36px;
				}

				#downloadButton {
					display: none;
				}
			}

			@media all and (max-height: 400px) {
				.text-below {
					bottom: 10px;
				}
			}

			@media all and (max-height: 360px) {
				.text-below {
					bottom: 5px;
					font-size: 32px;
				}
			}
		</style>

		<style id="toggleStyle1">
			#board div:not(div:has(img)):hover {
				cursor: pointer;
				background-color: #83c5be50;
			}

			#board div:not(div:has(img)):focus {
				background-color: #83c5be50;
			}
		</style>
	</head>

	<body draggable="false">
		<p id="backButton" style="display: none" class="button" tabindex="1">
			<span class="material-symbols-outlined" style="translate: 0 2px; margin-right: 5px">navigate_before</span>Back
		</p>

		<div id="board" draggable="false" style="display: none">
			<div id="square1" tabindex="2"></div>
			<div id="square2" tabindex="3"></div>
			<div id="square3" tabindex="4"></div>

			<div id="square4" tabindex="5"></div>
			<div id="square5" tabindex="6"></div>
			<div id="square6" tabindex="7"></div>

			<div id="square7" tabindex="8"></div>
			<div id="square8" tabindex="9"></div>
			<div id="square9" tabindex="10"></div>
		</div>

		<p class="text-below" style="display: none">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></p>

		<p id="code" class="brown button" style="display: none" title="click to copy link" tabindex="0"></p>

		<div class="menu">
			<p id="exitButton" class="button" style="top: 10px; left: 20px" tabindex="0">
				<span class="material-symbols-outlined" style="translate: 0 2px; margin-right: 5px">navigate_before</span>Exit
			</p>

			<div class="main-menu">
				<h1>TicTacToe</h1>
				<p id="newGameButton" tabindex="0" style="user-select: none">NEW GAME</p>
				<form name="joinGameForm" style="user-select: none">
					<input
						name="joinGameInput"
						type="text"
						placeholder="ENTER GAME CODE"
						maxlength="5"
						autocapitalize="off"
						spellcheck="false"
						autocomplete="off"
						pattern="^[a-z]{5}$"
					/>
				</form>
			</div>

			<p class="big-icon light-blue button-tray">
				<span class="material-symbols-outlined" tabindex="0" id="helpButton" title="how to play">help</span>
				<span class="material-symbols-outlined" tabindex="0" id="infoButton" title="data">info</span>
				<span class="material-symbols-outlined" tabindex="0" id="downloadButton" title="download Java version">download_for_offline</span>
				<span class="material-symbols-outlined" tabindex="0" id="feedbackButton" title="feedback/support Discord server">error</span>
				<span class="material-symbols-outlined" tabindex="0" id="newTabButton" title="open in another tab">outbound</span>
			</p>
		</div>

		<div class="data-page" style="display: none">
			<p id="backButton2" class="button" tabindex="1"><span class="material-symbols-outlined" style="translate: 0 2px; margin-right: 5px">navigate_before</span>Back</p>

			<div class="data-area">
				<h1 style="font-weight: normal">TicTacToe data <span class="material-symbols-outlined" id="data-refresh" title="refresh">refresh</span></h1>

				<div class="tooltip-zone" id="tooltip-zone-01">
					<p>games created <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-gameStatus-waiting">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-02">
					<p>games started <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-gameStatus-started">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-03">
					<p>games joined <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-gameStatus-playing">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-04">
					<p>games completed <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-gameStatus-done">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-05">
					<p>games won by X <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-winType-x">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-06">
					<p>games won by O <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-winType-o">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-07">
					<p>games tied <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-winType-null">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-08">
					<p>average number of moves <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-averageMoveNumber">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-09">
					<p>average game length <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-averageGameTime">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-10">
					<p>shortest recorded game <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-shortestGameTime">coming soon<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-11">
					<p>longest recorded game <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-longestGameTime">coming soon<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-12">
					<p>games continued <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-timesNextPressed">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-13">
					<p>most common first move <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-move-first-all">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-14">
					<p>most common last move <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-move-last-all">Loading<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-15">
					<p>most common first move in games won by X <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-move-first-x">coming soon<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-16">
					<p>most common last move in games won by X <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-move-last-x">coming soon<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-17">
					<p>most common first move in games won by O <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-move-first-o">coming soon<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-18">
					<p>most common last move in games won by O <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-move-last-o">coming soon<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-19">
					<p>most common first move in tied games <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-move-first-null">coming soon<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div class="tooltip-zone" id="tooltip-zone-20">
					<p>most common last move in tied games <span class="small-icon material-symbols-outlined">info</span></p>
					<h2 id="data-move-last-null">coming soon<d id="d1">.</d><d id="d2">.</d><d id="d3">.</d></h2>
				</div>

				<div id="tooltip" style="display: none"></div>
			</div>
		</div>
	</body>

	<script type="module">
		// URL stuff
		const query = window.location.search;
		const item = new URLSearchParams(query);
		var origin = item.get("o");
		var gameCode = item.get("c");
		var oldGame = item.get("n");
		if (origin != 1) {
			origin = 0;
			if (gameCode != null && gameCode != "") window.history.pushState({}, "", `?o=${origin}&c=${gameCode}`);
			else window.history.pushState({}, "", `?o=${origin}`);
		}

		// variables
		var code;
		var move = "";
		var game = "";
		var keys = {};
		var turn = true;
		var player = true;
		var hasWon = false;
		var gameStarted = false;
		var squares = ["1", "2", "3", "4", "5", "6", "7", "8", "9"];
		var textBelow = document.querySelector("p.text-below");
		var ogToggleStyle1 = document.querySelector("#toggleStyle1").innerHTML;

		// perfect position
		function updateBodySize() {
			document.querySelector("body").style = `height: ${window.innerHeight}px`;
		}
		updateBodySize();

		// update perfect position on resize
		addEventListener("resize", (e) => {
			setTimeout(() => {
				updateBodySize();
			}, 500);
		});

		// exit game (go to menu)
		function exitGame() {
			if (window.location.href.includes("projects")) window.location.href = "tictactoe.html?o=" + origin;
			else window.location.href = "https://pinniped.page/projects/tictactoe.html?o=" + origin;
		}

		// exit 'app' (return to origin)
		function leave() {
			if (origin == 1) window.location.href = "../projects+.html";
			else window.location.href = "../projects.html";
		}

		// place X or O
		function placeXO(square, XO) {
			document.querySelector(`#square${square}`).innerHTML = `<img src="../images/ttt-${XO}.svg" draggable="false">`;
			squares[square - 1] = XO;
		}

		// swap turn
		function swapTurn() {
			turn = !turn;
			toggleHoverEffect();
		}

		// toggle hover effect
		function toggleHoverEffect() {
			if (document.querySelector("#toggleStyle1").innerHTML == "") document.querySelector("#toggleStyle1").innerHTML = ogToggleStyle1;
			else document.querySelector("#toggleStyle1").innerHTML = "";
		}

		// listen for clicks on square
		function handleClick(square) {
			console.log("handling click", turn, player);
			if (turn == player && document.querySelector(`#square${square}`).innerHTML == "" && !hasWon) {
				if (turn) placeXO(square, "x");
				else placeXO(square, "o");

				let move = "";
				if (player) move = move + "x";
				else move = move + "o";
				move = move + square;
				makeMove(move);

				swapTurn();
				//checkForWin();
			}
		}

		// win?
		function checkForWin() {
			if (squares[0] == squares[1] && squares[1] == squares[2]) handleWin(turn, 0, 1, 2);
			else if (squares[3] == squares[4] && squares[4] == squares[5]) handleWin(turn, 3, 4, 5);
			else if (squares[6] == squares[7] && squares[7] == squares[8]) handleWin(turn, 6, 7, 8);
			else if (squares[0] == squares[3] && squares[3] == squares[6]) handleWin(turn, 0, 3, 6);
			else if (squares[1] == squares[4] && squares[4] == squares[7]) handleWin(turn, 1, 4, 7);
			else if (squares[2] == squares[5] && squares[5] == squares[8]) handleWin(turn, 2, 5, 8);
			else if (squares[0] == squares[4] && squares[4] == squares[8]) handleWin(turn, 0, 4, 8);
			else if (squares[2] == squares[4] && squares[4] == squares[6]) handleWin(turn, 2, 4, 6);
			else if (
				(squares[0] == "x" || squares[0] == "o") &&
				(squares[1] == "x" || squares[1] == "o") &&
				(squares[2] == "x" || squares[2] == "o") &&
				(squares[3] == "x" || squares[3] == "o") &&
				(squares[4] == "x" || squares[4] == "o") &&
				(squares[5] == "x" || squares[5] == "o") &&
				(squares[6] == "x" || squares[6] == "o") &&
				(squares[7] == "x" || squares[7] == "o") &&
				(squares[8] == "x" || squares[8] == "o")
			) {
				handleWin();
			} else {
				return false;
			}
			return true;
		}

		// after win
		function handleWin(winner, win1, win2, win3) {
			endGame();
			const db = getDatabase();
			set(ref(db, "tictactoe/" + code + "/status"), "done");

			if (winner != null) {
				if (move.substring(0, 1) == "x") winner = true;
				else winner = false;
			}
			console.log("handleWin();", winner, player);

			if (winner == player) textBelow.innerHTML = "You win!";
			else if (winner != null) textBelow.innerHTML = "You lose.";
			else textBelow.innerHTML = "You tied.";
			hasWon = true;
			document.querySelector("#toggleStyle1").innerHTML = "";

			document.querySelector("#code").innerHTML = 'Next<span class="material-symbols-outlined" style="translate: 0 6px; margin-left: 5px">navigate_next</span>';
			document.querySelector("#code").classList.add("big-icon");
			document.querySelector("#code").setAttribute("title", "click to create another game");

			for (let i = 0; i < 9; i++) {
				if (i != win1 && i != win2 && i != win3) {
					let squareElement = document.querySelector(`#square${i + 1}`);
					if (squareElement.innerHTML != "") {
						squareElement.children[0].style = "opacity: 50%";
					}
				}
			}
		}

		// fullscreen (we like that)
		function toggleFullscreen() {
			if (document.fullscreenElement) document.exitFullscreen();
			else document.documentElement.requestFullscreen();
		}

		// keyboard shortcuts and related functions
		document.addEventListener("keydown", (e) => {
			keys[e.key] = true;

			if (e.keyCode > 48 && e.keyCode < 58 && gameStarted) handleClick(e.keyCode - 48);
			if (keys["Shift"] && e.key === "Enter") toggleFullscreen();

			if (e.key === "Enter") {
				if (document.activeElement == document.querySelector(".menu .button")) leave();
				if (document.activeElement == document.querySelector(".main-menu p")) createGame();
				if (document.activeElement == document.querySelector(".button")) exitGame();

				if (document.activeElement == document.querySelector("#helpButton")) window.open("../files/tictactoe.pdf");
				if (document.activeElement == document.querySelector("#infoButton")) {
					document.querySelector(".menu").style = "display: none";
					document.querySelector(".data-page").style = "display: block";
					document.querySelector("title").innerHTML = "TicTacToe data";
					crunchNumbers();
				}
				if (document.activeElement == document.querySelector("#backButton2")) {
					document.querySelector(".menu").style = "display: flex";
					document.querySelector(".data-page").style = "display: none";
					document.querySelector("title").innerHTML = "TicTacToe";
				}
				if (document.activeElement == document.querySelector("#downloadButton")) window.location.href = "../download.html?x=TicTacToe.jar";
				if (document.activeElement == document.querySelector("#feedbackButton")) window.open("https://discord.gg/yswDu7kywv");
				if (document.activeElement == document.querySelector("#newTabButton")) newWindow();
				if (document.activeElement == document.querySelector("#code")) {
					if (!hasWon) {
						createLink();
						document.querySelector("#code").innerHTML = "copied!";
						setTimeout(() => {
							document.querySelector("#code").innerHTML = code;
						}, 3000);
					} else {
						window.location.href = `https://pinniped.page/projects/tictactoe?o=${origin}&n=${code}`;
					}
				}

				for (let i = 1; i <= 9; i++) if (document.activeElement == document.querySelector(`#square${i}`)) handleClick(i);
			}
		});
		document.addEventListener("keyup", (e) => {
			delete keys[e.key];
		});

		// prevent default form submitting
		document.querySelector("form").addEventListener("submit", (e) => {
			e.preventDefault();
			code = document.joinGameForm.joinGameInput.value;
			joinGame();
		});

		// generate game code
		const chars = [
			"a",
			"b",
			"c",
			"d",
			"e",
			"f",
			"g",
			"h",
			"i",
			"j",
			"k",
			"l",
			"m",
			"n",
			"o",
			"p",
			"q",
			"r",
			"s",
			"t",
			"u",
			"v",
			"w",
			"x",
			"y",
			"z",
			// "A",
			// "B",
			// "C",
			// "D",
			// "E",
			// "F",
			// "G",
			// "H",
			// "I",
			// "J",
			// "K",
			// "L",
			// "M",
			// "N",
			// "O",
			// "P",
			// "Q",
			// "R",
			// "S",
			// "T",
			// "U",
			// "V",
			// "W",
			// "X",
			// "Y",
			// "Z",
			// "0",
			// "1",
			// "2",
			// "3",
			// "4",
			// "5",
			// "6",
			// "7",
			// "8",
			// "9",
		];
		function genCode(length) {
			let codeString = "";
			for (let i = 0; i < length; i++) codeString = codeString + chars[Math.floor(Math.random() * chars.length)];
			code = codeString;
		}

		// show/hide board
		function toggleBoardDisplay(showHide) {
			if (showHide) {
				document.querySelector(".menu").style = "display: none";

				document.querySelector(".button").style = "display: block";
				document.querySelector("#board").style = "display: flex";
				document.querySelector(".text-below").style = "display: block";
				document.querySelector("#code").style = "display: block";
			} else {
				document.querySelector(".menu").style = "display: flex";

				document.querySelector(".button").style = "display: none";
				document.querySelector("#board").style = "display: none";
				document.querySelector(".text-below").style = "display: none";
				document.querySelector("#code").style = "display: none";
			}
		}

		// show the code and put it in the URL and title
		function setCode(code) {
			window.history.pushState({}, "", `?o=${origin}&c=${code}`);
			document.querySelector("title").innerHTML = "TicTacToe | " + code;
			document.querySelector("#code").innerHTML = code;
		}

		// create a new game
		function createGame() {
			genCode(5);
			initGame(code);
			setCode(code);
			//textBelow.innerHTML = "It's your turn!";
			toggleBoardDisplay(true);
			gameStarted = true;

			if (oldGame != null && oldGame != "") {
				const db = getDatabase();
				set(ref(db, "tictactoe/" + oldGame + "/next"), code);
			}
		}

		// join an existing game
		function joinGame() {
			setCode(code);
			findGame();
			toggleBoardDisplay(true);
		}

		// open a new TicTacToe window
		function newWindow() {
			if (window.location.href.includes("projects")) window.open(`tictactoe.html?o=${origin}`);
			else window.open(`https://pinniped.page/projects/tictactoe.html?o=${origin}`);
		}

		// click listeners
		document.querySelector("#backButton").addEventListener("click", (e) => {
			exitGame();
		});
		document.querySelector("#exitButton").addEventListener("click", (e) => {
			leave();
		});
		document.querySelector("#newGameButton").addEventListener("click", (e) => {
			createGame();
		});
		document.querySelector("#helpButton").addEventListener("click", (e) => {
			window.open("../files/tictactoe.pdf");
		});
		document.querySelector("#infoButton").addEventListener("click", (e) => {
			document.querySelector(".menu").style = "display: none";
			document.querySelector(".data-page").style = "display: block";

			document.querySelector("title").innerHTML = "TicTacToe data";
			crunchNumbers();
		});
		document.querySelector("#backButton2").addEventListener("click", (e) => {
			document.querySelector(".menu").style = "display: flex";
			document.querySelector(".data-page").style = "display: none";

			document.querySelector("title").innerHTML = "TicTacToe";
		});
		document.querySelector("#downloadButton").addEventListener("click", (e) => {
			window.location.href = "../download.html?x=TicTacToe.jar";
		});
		document.querySelector("#feedbackButton").addEventListener("click", (e) => {
			window.open("https://discord.gg/yswDu7kywv");
		});
		document.querySelector("#newTabButton").addEventListener("click", (e) => {
			newWindow();
		});
		document.querySelector("#code").addEventListener("click", (e) => {
			if (!hasWon) {
				createLink();
				document.querySelector("#code").innerHTML = "copied!";
				setTimeout(() => {
					document.querySelector("#code").innerHTML = code;
				}, 3000);
			} else {
				window.location.href = `https://pinniped.page/projects/tictactoe?o=${origin}&n=${code}`;
			}
		});
		for (let i = 1; i <= 9; i++) {
			document.querySelector(`#square${i}`).addEventListener("click", (e) => {
				handleClick(i);
			});
		}

		// --- FIREBASE ---

		// fireBASED
		import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
		import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

		// firebase = wow!
		const firebaseConfig = {
			apiKey: "AIzaSyAigBAgn7Uhybip_m3P508DIpybb2qdI5g",
			authDomain: "the-pinniped-page.firebaseapp.com",
			databaseURL: "https://the-pinniped-page.firebaseio.com",
			projectId: "the-pinniped-page",
			storageBucket: "the-pinniped-page.appspot.com",
			messagingSenderId: "636989973689",
			appId: "1:636989973689:web:6d938d9588606d803a6768",
		};
		const app = initializeApp(firebaseConfig);

		// create game - on Firebase Realtime Database
		function initGame(code) {
			const db = getDatabase();
			let date = new Date();

			set(ref(db, "tictactoe/" + code), {
				created: {
					date: date.toString(),
					timestamp: date.getTime(),
				},
				status: "waiting",
				turn: "x",
				move: "-",
				game: "-",
			});
			getOpponentMoves();
		}

		// make move on server
		function makeMove(move) {
			const db = getDatabase();

			set(ref(db, "tictactoe/" + code + "/move"), move);
			if (player) set(ref(db, "tictactoe/" + code + "/turn"), "o");
			else set(ref(db, "tictactoe/" + code + "/turn"), "x");

			console.log(game, move);
			if (game == "") game = move;
			else game = game + " " + move;
			set(ref(db, "tictactoe/" + code + "/game"), game);
		}

		// find game? !!! this kinda goes against the 'modular functions' I'm going for - or something like that
		function findGame() {
			const db = getDatabase();
			const dbRef = ref(getDatabase());

			get(child(dbRef, "tictactoe/" + code)).then((snapshot) => {
				if (!snapshot.exists()) {
					textBelow.innerHTML = "ERROR: game not found";
					hasWon = true; // well, uh, technically, uh, nah
				} else {
					const data = snapshot.val();
					let status = data.status.toString();
					let dbTurn = data.turn.toString();
					console.log(status, dbTurn);

					if (status == "waiting") {
						set(ref(db, "tictactoe/" + code + "/status"), "playing");

						if (dbTurn == "x") {
							//textBelow.innerHTML = "Waiting for opponent<d id='d1'>.</d><d id='d2'>.</d><d id='d3'>.</d>";
							document.querySelector("#toggleStyle1").innerHTML = "";
						} else {
							//textBelow.innerHTML = "It's your turn!";
							toggleHoverEffect();
						}

						player = false;
						getOpponentMoves();
						gameStarted = true;
					} else {
						textBelow.innerHTML = "ERROR: ongoing game";
						hasWon = true; // well, uh, technically, uh, nah
					}
				}
			});
		}

		// URL stuff 2.0
		if (gameCode != null && gameCode != "") {
			if (/^[a-z]{5}$/.test(gameCode)) {
				code = gameCode;
				joinGame();
			}
		}

		// get opponent moves
		function getOpponentMoves() {
			const db = getDatabase();
			const moveRef = ref(db, "tictactoe/" + code + "/move");
			const turnRef = ref(db, "tictactoe/" + code + "/turn");
			const nextRef = ref(db, "tictactoe/" + code + "/next");

			onValue(moveRef, (snapshot) => {
				const data = snapshot.val();

				if (data != null) {
					let newData = data.toString();
					if (newData != "-") {
						move = newData;
						placeXO(newData.substring(1, 2), newData.substring(0, 1));
						if ((newData.substring(0, 1) == "x" && !player) || (newData.substring(0, 1) == "o" && player)) {
							console.log(newData + " | " + game);
							if (game == "") game = newData;
							else game = game + " " + newData;
							console.log(newData + " | " + game);
							swapTurn();
						}
					}
				}
			});

			onValue(turnRef, (snapshot) => {
				const data = snapshot.val();

				if (data != null) {
					let newData = data.toString();

					console.log("checkForWin();" + !checkForWin());
					if (!checkForWin()) {
						if (newData == "x") {
							if (player) {
								textBelow.innerHTML = "It's your turn!";
							} else {
								textBelow.innerHTML = "Waiting for opponent<d id='d1'>.</d><d id='d2'>.</d><d id='d3'>.</d>";
							}
						} else {
							if (player) {
								textBelow.innerHTML = "Waiting for opponent<d id='d1'>.</d><d id='d2'>.</d><d id='d3'>.</d>";
							} else {
								textBelow.innerHTML = "It's your turn!";
							}
						}
					}
				}
			});

			onValue(nextRef, (snapshot) => {
				if (snapshot.exists()) {
					const data = snapshot.val();
					console.log(data);

					if (data != null) {
						let newData = data.toString();

						window.location.href = `https://pinniped.page/projects/tictactoe.html?o=${origin}&c=${newData}`;
					}
				}
			});
		}

		// copy link to game
		function createLink() {
			navigator.clipboard.writeText(`https://pinniped.page/ttt?c=${code}`);
		}

		// going back should return to menu
		addEventListener("popstate", (e) => {
			console.log("POPSTATE");
			if (window.location.href.includes("projects")) window.location.href = "tictactoe.html?o=" + origin;
			else window.location.href = "https://pinniped.page/projects/tictactoe.html?o=" + origin;
		});

		// end game (add date + time to db)
		function endGame() {
			const db = getDatabase();
			let date = new Date();

			set(ref(db, "tictactoe/" + code + "/ended"), {
				date: date.toString(),
				timestamp: date.getTime(),
			});
		}

		// auto start game
		if (oldGame != null && oldGame != "") {
			createGame();
		}

		// data a.k.a. BIG BOI NUMBER CRUNCHING
		const moveNames = ["top left", "top middle", "top right", "middle left", "centre", "middle right", "bottom left", "bottom middle", "bottom right"];

		async function crunchNumbers() {
			const db = getDatabase();
			var bigData;

			await get(ref(db, "tictactoe")).then((snapshot) => {
				bigData = snapshot.val();
			});

			// 1. data.gameStatus.waiting
			let totalGames = 0;
			for (const game in bigData) totalGames++;
			document.querySelector("#data-gameStatus-waiting").innerHTML = totalGames;

			// 2.
			var gamesWithAMove = 0;
			for (const game in bigData) {
				let number = parseInt(bigData[game].game.substring(1, 2));
				if (number > 0) gamesWithAMove++;
			}
			document.querySelector("#data-gameStatus-started").innerHTML = `${gamesWithAMove} <span>(${Math.round((gamesWithAMove / totalGames) * 10000) / 100}%)</span>`;

			// 3. data.gameStatus.playing
			let stillWaiting = 0;
			for (const game in bigData) {
				if (bigData[game].status == "waiting") stillWaiting++;
			}
			let gamesStarted = totalGames - stillWaiting;
			document.querySelector("#data-gameStatus-playing").innerHTML = `${gamesStarted} <span>(${Math.round((gamesStarted / totalGames) * 10000) / 100}%)</span>`;

			// 4. data.gameStatus.done
			let stillPlaying = 0;
			for (const game in bigData) {
				if (bigData[game].status == "playing") stillPlaying++;
			}
			let gamesCompleted = totalGames - stillWaiting - stillPlaying;
			document.querySelector("#data-gameStatus-done").innerHTML = `${gamesCompleted} <span>(${Math.round((gamesCompleted / totalGames) * 10000) / 100}%)</span>`;

			// use later:

			var firstMovesX = [0, 0, 0, 0, 0, 0, 0, 0, 0];
			var firstMovesO = [0, 0, 0, 0, 0, 0, 0, 0, 0];
			var firstMovesTie = [0, 0, 0, 0, 0, 0, 0, 0, 0];

			var lastMovesX = [0, 0, 0, 0, 0, 0, 0, 0, 0];
			var lastMovesO = [0, 0, 0, 0, 0, 0, 0, 0, 0];
			var lastMovesTie = [0, 0, 0, 0, 0, 0, 0, 0, 0];

			// 5. data.winType.x
			let xWins = 0;
			for (const game in bigData) {
				if (bigData[game].status == "done") {
					let board = ["s1", "s2", "s3", "s4", "s5", "s6", "s7", "s8", "s9"];
					let movesMade = bigData[game].game.split(" ");

					for (let i = 0; i < movesMade.length; i++) {
						board[movesMade[i].substring(1, 2) - 1] = movesMade[i].substring(0, 1);
					}

					if (bigData[game].turn == "o") {
						if (
							(board[0] == board[1] && board[1] == board[2]) ||
							(board[3] == board[4] && board[4] == board[5]) ||
							(board[6] == board[7] && board[7] == board[8]) ||
							(board[0] == board[3] && board[3] == board[6]) ||
							(board[1] == board[4] && board[4] == board[7]) ||
							(board[2] == board[5] && board[5] == board[8]) ||
							(board[0] == board[4] && board[4] == board[8]) ||
							(board[2] == board[4] && board[4] == board[6])
						) {
							xWins++;

							let firstNumber = parseInt(bigData[game].game.substring(1, 2));
							if (firstNumber > 0) firstMovesX[firstNumber - 1]++;

							let lastNumber = parseInt(bigData[game].game.substring(bigData[game].game.length - 1));
							if (lastNumber > 0) lastMovesX[lastNumber - 1]++;
						}
					}
				}
			}
			document.querySelector("#data-winType-x").innerHTML = `${xWins} <span>(${Math.round((xWins / gamesCompleted) * 10000) / 100}%)</span>`;

			// 6. data.winType.o
			let oWins = 0;
			for (const game in bigData) {
				if (bigData[game].status == "done") {
					let board = ["s1", "s2", "s3", "s4", "s5", "s6", "s7", "s8", "s9"];
					let movesMade = bigData[game].game.split(" ");

					for (let i = 0; i < movesMade.length; i++) {
						board[movesMade[i].substring(1, 2) - 1] = movesMade[i].substring(0, 1);
					}

					if (bigData[game].turn == "x") {
						if (
							(board[0] == board[1] && board[1] == board[2]) ||
							(board[3] == board[4] && board[4] == board[5]) ||
							(board[6] == board[7] && board[7] == board[8]) ||
							(board[0] == board[3] && board[3] == board[6]) ||
							(board[1] == board[4] && board[4] == board[7]) ||
							(board[2] == board[5] && board[5] == board[8]) ||
							(board[0] == board[4] && board[4] == board[8]) ||
							(board[2] == board[4] && board[4] == board[6])
						) {
							oWins++;

							let firstNumber = parseInt(bigData[game].game.substring(1, 2));
							if (firstNumber > 0) firstMovesO[firstNumber - 1]++;

							let lastNumber = parseInt(bigData[game].game.substring(bigData[game].game.length - 1));
							if (lastNumber > 0) lastMovesO[lastNumber - 1]++;
						}
					}
				}
			}
			document.querySelector("#data-winType-o").innerHTML = `${oWins} <span>(${Math.round((oWins / gamesCompleted) * 10000) / 100}%)</span>`;

			// 7. data.winType.null
			let ties = 0;
			for (const game in bigData) {
				if (bigData[game].status == "done") {
					let board = ["s1", "s2", "s3", "s4", "s5", "s6", "s7", "s8", "s9"];
					let movesMade = bigData[game].game.split(" ");

					for (let i = 0; i < movesMade.length; i++) {
						board[movesMade[i].substring(1, 2) - 1] = movesMade[i].substring(0, 1);
					}

					if (
						!(
							(board[0] == board[1] && board[1] == board[2]) ||
							(board[3] == board[4] && board[4] == board[5]) ||
							(board[6] == board[7] && board[7] == board[8]) ||
							(board[0] == board[3] && board[3] == board[6]) ||
							(board[1] == board[4] && board[4] == board[7]) ||
							(board[2] == board[5] && board[5] == board[8]) ||
							(board[0] == board[4] && board[4] == board[8]) ||
							(board[2] == board[4] && board[4] == board[6])
						)
					) {
						ties++;

						let firstNumber = parseInt(bigData[game].game.substring(1, 2));
						if (firstNumber > 0) firstMovesTie[firstNumber - 1]++;

						let lastNumber = parseInt(bigData[game].game.substring(bigData[game].game.length - 1));
						if (lastNumber > 0) lastMovesTie[lastNumber - 1]++;
					}
				}
			}
			document.querySelector("#data-winType-null").innerHTML = `${ties} <span>(${Math.round((ties / gamesCompleted) * 10000) / 100}%)</span>`;

			// 8. data.averageMoveNumber
			let totalMovesInDoneGames = 0;
			for (const game in bigData) {
				if (bigData[game].status == "done") totalMovesInDoneGames += (bigData[game].game.length + 1) / 3;
			}
			let averageMoves = Math.round((totalMovesInDoneGames / gamesCompleted) * 100) / 100;
			document.querySelector("#data-averageMoveNumber").innerHTML = averageMoves;

			// 9. data.averageGameTime
			let totalTime = 0;
			var shortestTime = Infinity;
			var longestTime = 0;
			for (const game in bigData) {
				if (bigData[game].status == "done") {
					let time = (bigData[game].ended.timestamp - bigData[game].created.timestamp) / 1000;
					totalTime += time;
					if (time > longestTime) longestTime = time;
					if (time < shortestTime) shortestTime = time;
				}
			}
			let averageTime = Math.round((totalTime / gamesCompleted) * 100) / 100;
			document.querySelector("#data-averageGameTime").innerHTML = `${averageTime} seconds`;

			// 10.
			document.querySelector("#data-shortestGameTime").innerHTML = `${Math.round(shortestTime * 100) / 100} seconds`;

			// 11.
			document.querySelector("#data-longestGameTime").innerHTML = `${Math.round(longestTime * 100) / 100} seconds`;

			// 12. data.timesNextPressed
			let nextPresses = 0;
			for (const game in bigData) {
				if (bigData[game].next != undefined) nextPresses++;
			}
			document.querySelector("#data-timesNextPressed").innerHTML = `${nextPresses} <span>(${Math.round((nextPresses / gamesCompleted) * 10000) / 100}%)</span>`;

			// 13. data.move.first
			var firstMoves = [0, 0, 0, 0, 0, 0, 0, 0, 0];
			for (const game in bigData) {
				let number = parseInt(bigData[game].game.substring(1, 2));
				if (number > 0) firstMoves[number - 1]++;
			}
			document.querySelector("#data-move-first-all").innerHTML = `${moveNames[firstMoves.indexOf(Math.max(...firstMoves))]} <span>(${Math.max(...firstMoves)})</span>`;

			// 14. data.move.last
			var lastMoves = [0, 0, 0, 0, 0, 0, 0, 0, 0];
			for (const game in bigData) {
				let number = parseInt(bigData[game].game.substring(bigData[game].game.length - 1));
				if (number > 0 && bigData[game].status == "done") lastMoves[number - 1]++;
			}
			document.querySelector("#data-move-last-all").innerHTML = `${moveNames[lastMoves.indexOf(Math.max(...lastMoves))]} <span>(${Math.max(...lastMoves)})</span>`;

			console.table(firstMoves, firstMovesX, firstMovesO, firstMovesTie);
			console.table(lastMoves, lastMovesX, lastMovesO, lastMovesTie);

			// 15.
			document.querySelector("#data-move-first-x").innerHTML = `${moveNames[firstMovesX.indexOf(Math.max(...firstMovesX))]} <span>(${Math.max(...firstMovesX)})</span>`;

			// 16.
			document.querySelector("#data-move-last-x").innerHTML = `${moveNames[lastMovesX.indexOf(Math.max(...lastMovesX))]} <span>(${Math.max(...lastMovesX)})</span>`;

			// 17.
			document.querySelector("#data-move-first-o").innerHTML = `${moveNames[firstMovesO.indexOf(Math.max(...firstMovesO))]} <span>(${Math.max(...firstMovesO)})</span>`;

			// 18.
			document.querySelector("#data-move-last-o").innerHTML = `${moveNames[lastMovesO.indexOf(Math.max(...lastMovesO))]} <span>(${Math.max(...lastMovesO)})</span>`;

			// 19.
			document.querySelector("#data-move-first-null").innerHTML = `${moveNames[firstMovesTie.indexOf(Math.max(...firstMovesTie))]} <span>(${Math.max(
				...firstMovesTie
			)})</span>`;

			// 20.
			document.querySelector("#data-move-last-null").innerHTML = `${moveNames[lastMovesTie.indexOf(Math.max(...lastMovesTie))]} <span>(${Math.max(
				...lastMovesTie
			)})</span>`;
		}

		// --- TOOLTIPS ---
		var tooltip = document.querySelector("#tooltip");

		// list
		const tooltips = [
			'number of times the "new game" and "next" buttons have been clicked',
			"games with at least one move (of the total created games)",
			"number of games joined by a second player (of the total created games)",
			"number of games won or tied (of the total created games)",
			"number of games won by player one (of the total completed games)",
			"number of games won by player two (of the total completed games)",
			"number of games with no winner (of the total completed games)",
			"average number of moves in completed games",
			"average time between completed games' <u>creation</u> and completion",
			"time between the shortest completed game's <u>creation</u> and completion", // add!
			"time between the longest completed game's <u>creation</u> and completion", // add!
			'number of games continued for another round by way of the "next" button (of the total completed games)',
			"position of the most common first move overall (in <u>started</u> games)",
			"position of the most common last move overall (in completed games)",
			"position of the most common first move in games won by X", // add; provide the number!
			"position of the most common last move in games won by X", // add; provide the number!
			"position of the most common first move in games won by O", // add; provide the number!
			"position of the most common last move in games won by O", // add; provide the number!
			"position of the most common first move in tied games", // add; provide the number!
			"position of the most common last move in tied games", // add; provide the number!
		];

		// get & show & hide
		document.querySelectorAll(".tooltip-zone").forEach((tooltipZone) => {
			tooltipZone.addEventListener("mousemove", (e) => {
				let tooltipNumber = parseInt(tooltipZone.id.substring(tooltipZone.id.length - 2)) - 1;
				tooltip.innerHTML = tooltips[tooltipNumber];
				tooltip.style = `top: ${e.clientY + 10}px; left: ${e.clientX + 20}px`;
			});
			tooltipZone.addEventListener("mouseout", (e) => {
				tooltip.style = "opacity: 0";
			});
		});

		// refresh button
		document.querySelector("#data-refresh").addEventListener("click", (e) => {
			crunchNumbers();
		});
	</script>
</html>
