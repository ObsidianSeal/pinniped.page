<!DOCTYPE html>

<html lang="en">
	<head>
		<title>text</title>

		<meta charset="UTF-8" />

		<link rel="icon" href="../images/icon.png" />

		<meta name="theme-color" content="#4ecdc4" />

		<script src="https://kit.fontawesome.com/c6ef7d4818.js" crossorigin="anonymous"></script>

		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<meta property="og:url" content="https://pinniped.page/projects/text" />
		<meta property="og:type" content="website" />
		<meta property="og:title" content="text" />
		<meta property="og:description" content="I'm trying to learn Firebase Realtime Database" />
		<meta property="og:image" content="https://pinniped.page/images/icon.png" />

		<script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js" defer></script>
		<script src="https://www.gstatic.com/firebasejs/4.3.0/firebase.js" defer></script>

		<style>
			@import url("https://fonts.googleapis.com/css2?family=Roboto+Mono");

			body {
				background-color: #edf2f4;
				color: #2b2d42;
				margin: 0;
				border: 0;
				padding: 0;
				font-family: "Roboto Mono";
				font-size: 20px;
			}

			::selection {
				background: #8d99ae;
				color: #edf2f4;
			}

			::-webkit-scrollbar {
				width: 1em;
			}

			::-webkit-scrollbar-track {
				background: #8d99ae;
			}

			::-webkit-scrollbar-thumb {
				background: #2b2d42;
			}

			::-webkit-scrollbar-thumb:hover {
				background: #ef233c;
			}

			::-webkit-scrollbar-corner {
				background: #2b2d42;
			}

			p {
				margin-block-start: 0;
				margin-block-end: 0;
				word-wrap: break-word;
				line-height: 30px;
				padding: 30px 20px 100px 20px;
			}

			form {
				background-color: #edf2f4;
				box-shadow: 0 0 10px 5px #8d99ae;
				display: flex;
				gap: 20px;
				width: 100%;
				position: fixed;
				padding: 20px 0 20px 20px;
				z-index: 1;
			}

			input {
				width: calc(100% - 128px);
				max-width: 500px;
				height: 36px;
				background-color: #edf2f4;
				border: 3px solid #2b2d42;
				padding: 0 10px 0 10px;
				outline: none;
				font-family: "Roboto Mono";
				font-size: 20px;
			}

			input:focus {
				border-color: #ef233c;
				border-radius: 0;
			}

			div#textButton {
				height: 42px;
				width: 42px;
				min-width: 42px;
				background-color: #2b2d42;
				border: 0;
				padding: 0;
				display: flex;
				justify-content: center;
				align-items: center;
			}

			div#textButton:hover {
				background-color: #ef233c;
				cursor: pointer;
			}

			div {
				height: 82px;
			}

			i {
				color: #edf2f4;
			}
		</style>
	</head>

	<body>
		<form name="textForm" id="textForm">
			<input name="textInput" id="textInput" maxlength="120" />
			<div id="textButton"><i class="fa-solid fa-share"></i></div>
		</form>

		<div></div>

		<p id="textSpace"></p>

		<script type="module">
			// firebase config
			const firebaseConfig = {
				apiKey: "AIzaSyAigBAgn7Uhybip_m3P508DIpybb2qdI5g",
				authDomain: "the-pinniped-page.firebaseapp.com",
				databaseURL: "https://the-pinniped-page.firebaseio.com",
				projectId: "the-pinniped-page",
				storageBucket: "the-pinniped-page.appspot.com",
				messagingSenderId: "636989973689",
				appId: "1:636989973689:web:6d938d9588606d803a6768",
			};

			// initialize the app
			firebase.initializeApp(firebaseConfig);
			//let number = 0;

			// write to the database
			function writeText(text) {
				if (!/^[ ]+$/.test(text) && text != "") {
					const date = new Date();
					let year = date.getFullYear();
					let month = date.getMonth() + 1;
					let day = date.getDate();
					let hours = date.getUTCHours();
					let minutes = date.getMinutes();
					if (month < 10) month = `0${month}`;
					if (day < 10) day = `0${day}`;

					var textListRef = firebase.database().ref("/text");
					var newTextRef = textListRef.push();
					newTextRef.set({
						text: text,
						date: `${year}/${month}/${day}`,
						hours: hours,
						minutes: minutes,
					});
				}
				document.getElementById("textInput").value = "";
				document.getElementById("textSpace").innerHTML = "";
			}

			// get the other messages
			function updateText() {
				const date = new Date();
				let offset = date.getTimezoneOffset();
				document.getElementById("textSpace").innerHTML = "";
				firebase
					.database()
					.ref("/text")
					.on("value", function (snap) {
						snap.forEach(function (childNodes) {
							let newHours = childNodes.val().hours - Math.floor(offset / 60);
							if (newHours < 0) newHours = newHours + 24;
							if (newHours > 24) newHours = newHours - 24;

							let newMinutes = childNodes.val().minutes;
							newMinutes = newMinutes - (offset % 60);
							if (newMinutes < 0) {
								newMinutes += 60;
								newHours--;
							}
							if (newMinutes >= 60) {
								newMinutes -= 60;
								newHours++;
							}

							newMinutes = newMinutes.toLocaleString("en", {
								minimumIntegerDigits: 2,
								useGrouping: false,
							});
							document.getElementById("textSpace").innerHTML =
								document.getElementById("textSpace").innerHTML + `<b>${childNodes.val().date} ${newHours}:${newMinutes} </b> `;

							var newText = document.createTextNode(childNodes.val().text);
							if (newText.length <= 120) document.getElementById("textSpace").appendChild(newText);
							else document.getElementById("textSpace").innerHTML = document.getElementById("textSpace").innerHTML + "...";
							document.getElementById("textSpace").innerHTML = document.getElementById("textSpace").innerHTML + "<br>";
						});
					});
			}
			updateText();

			// don't reload on 'enter', writeText, and updateText (for now)
			document.getElementById("textForm").addEventListener("submit", function (e) {
				e.preventDefault();
				writeText(document.textForm.textInput.value);
				updateText();
			});

			// writeText on button press, and updateText (for now)
			document.getElementById("textButton").addEventListener("click", function (e) {
				writeText(document.textForm.textInput.value);
				updateText();
			});

			// update the text every 2 seconds (for some reason, changes to the database add all the text multiple times)
			//window.setInterval(updateText, 2000);

			// listen for database changes, then update when it does
			firebase
				.database()
				.ref("/text")
				.on("value", (snapshot) => {
					//const data = snapshot.val();
					//console.log(data);
					setTimeout(function (params) {
						updateText();
					}, 50); // is 50ms okay?
				});
		</script>
	</body>
</html>
